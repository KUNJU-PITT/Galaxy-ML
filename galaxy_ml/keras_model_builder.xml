<tool id="keras_model_builder" name="Keras Model Builder" version="@VERSION@">
  <description>constructs a deep learning model with sciki-learn APIs</description>
  <macros>
    <import>main_macros.xml</import>
    <import>keras_macros.xml</import>
  </macros>
  <expand macro="python_requirements"/>
  <expand macro="macro_stdio"/>
  <version_command>echo "@VERSION@"</version_command>
  <command>
    <![CDATA[
    python '$__tool_directory__/keras_deep_learning.py'
           '$inputs'
           'keras_model_builder'
           '$outfile'
           '$mode_selection.infile_json'
           #if $mode_selection.mode_type == 'prefitted'
           '$mode_selection.infile_weights'
           #end if

    ]]>
  </command>
  <configfiles>
    <inputs name="inputs"/>
  </configfiles>
  <inputs>
    <conditional name="mode_selection">
      <param name="mode_type" type="select" label="Choose a building mode">
        <option value="train_model" selected="true">Build a training model</option>
        <option value="prefitted">Load a pretrained model for prediction</option>
      </param>
      <when value="train_model">
        <param name="infile_json" type="data" format="json" label="Select the dataset containing model configurations (JSON)"/>
        <param name="learning_type" type="select" label="Do classification or regression?">
          <option value="KerasGClassifier">KerasGClassifier</option>
          <option value="KerasGRegressor">KerasGRegressor</option>
        </param>
        <expand macro="keras_compile_params_section"/>
        <expand macro="keras_fit_params_section"/>
        <param name="random_seed" type="integer" value="0" label="Random Seed" help="Integer or blank for None"/>
      </when>
      <when value="prefitted">
        <param name="infile_json" type="data" format="json" label="Select the dataset containing model configurations (JSON)"/>
        <param name="infile_weights" type="data" format="h5" label="Select the dataset containing keras layers weights"/>
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data format="zip" name="outfile" label="Keras Model Builder  on ${on_string}"/>
  </outputs>
  <tests>
    <test>
      <conditional name="mode_selection">
        <param name="infile_json" value="keras01.json" ftype="json"/>
        <param name="learning_type" value="KerasGRegressor"/>
        <section name="fit_params">
          <param name="epochs" value="100"/>
        </section>
      </conditional>
      <output name="outfile" file="keras_model01" compare="sim_size" delta="5"/>
    </test>
    <test>
      <conditional name="mode_selection">
        <param name="infile_json" value="keras02.json" ftype="json"/>
        <section name="compile_params">
          <conditional name="optimizer_selection">
            <param name="optimizer_type" value="Adam"/>
          </conditional>
        </section>
        <section name="fit_params">
          <param name="epochs" value="100"/>
        </section>
      </conditional>
      <output name="outfile" file="keras_model02" compare="sim_size" delta="5"/>
    </test>
    <test>
      <conditional name="mode_selection">
        <param name="mode_type" value="prefitted"/>
        <param name="infile_json" value="keras03.json" ftype="json"/>
        <param name="infile_weights" value="keras_save_weights01.h5" ftype="h5"/>
      </conditional>
      <output name="outfile" file="keras_prefitted01.zip" compare="sim_size" delta="5"/>
    </test>
  </tests>
  <help>
      <![CDATA[
**Help**
      ]]>
  </help>
  <citations>
  </citations>
</tool>
